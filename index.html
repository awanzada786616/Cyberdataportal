<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Port | User Dashboard</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #f2f4f8; 
            padding-bottom: 80px;
        }

        /* --- HEADER STYLE --- */
        .custom-navbar {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .nav-title-badge {
            background-color: #ffc107;
            color: #000;
            font-weight: 700;
            padding: 5px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* --- CARDS STYLE --- */
        .info-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        .card-label {
            color: #3366cc;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .data-box {
            background: #f8f9fa;
            border: 1px solid #ced4da;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #333;
        }

        /* --- NOTICE BOARD --- */
        .notice-board {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid #ffc107;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #444;
        }

        /* --- PURCHASE FORM --- */
        .purchase-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        .form-select, .form-control {
            background-color: #f1f3f5;
            border: 1px solid #ced4da;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .btn-purchase {
            background-color: #ccc;
            color: #fff;
            font-weight: 600;
            width: auto;
            padding: 10px 30px;
            border-radius: 20px;
            margin-top: 15px;
            border: none;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: 0.3s;
        }
        .btn-purchase.active {
            background-color: #888;
            cursor: pointer;
        }
        .btn-purchase.active:hover {
            background-color: #666;
        }

        /* --- PENDING REQUESTS --- */
        .pending-title {
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .request-item {
            background: #fff;
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }
        .status-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
        }

        /* Auth Screen */
        #authSection { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #eef2f5; }
        .auth-card { background: white; padding: 30px; border-radius: 10px; width: 100%; max-width: 380px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <!-- AUTH SECTION -->
    <div id="authSection">
        <div class="auth-card">
            <div class="text-center mb-4">
                <img src="https://i.postimg.cc/43Wz0xLk/20251203-132914.png" width="60" alt="Logo">
                <h4 class="fw-bold mt-2">Login</h4>
            </div>
            <form id="loginForm">
                <input type="email" id="loginEmail" class="form-control mb-3" placeholder="Email" required>
                <input type="password" id="loginPass" class="form-control mb-3" placeholder="Password" required>
                <button class="btn btn-primary w-100 fw-bold">Login</button>
            </form>
            <p class="text-center mt-3 small">New User? <a href="#" onclick="toggleReg()">Create Account</a></p>
            
            <form id="regForm" style="display:none;" class="mt-3">
                <input type="email" id="regEmail" class="form-control mb-3" placeholder="New Email" required>
                <input type="password" id="regPass" class="form-control mb-3" placeholder="New Password" required>
                <button class="btn btn-success w-100 fw-bold">Sign Up</button>
                <p class="text-center mt-3 small"><a href="#" onclick="toggleReg()">Back to Login</a></p>
            </form>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="appSection" style="display: none;">
        
        <!-- Navbar -->
        <div class="custom-navbar">
            <img src="https://i.postimg.cc/43Wz0xLk/20251203-132914.png" width="40" alt="Logo" class="rounded-circle bg-white p-1">
            <div class="nav-title-badge">CYBER PORT</div>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div class="container mt-4">

            <!-- Username Card -->
            <div class="info-card">
                <div class="card-label"><i class="fas fa-user"></i> Username:</div>
                <div class="data-box">
                    <span id="displayEmail">Loading...</span>
                    <i class="fas fa-copy text-secondary" style="cursor:pointer" onclick="copyEmail()"></i>
                </div>
            </div>

            <!-- Balance Card -->
            <div class="info-card">
                <div class="card-label"><i class="fas fa-wallet"></i> Current Balance:</div>
                <div class="data-box">
                    <span><i class="fas fa-wallet text-success me-2"></i> <span id="userBal">0</span> PKR</span>
                    <i class="fas fa-sync-alt text-primary" style="cursor:pointer" onclick="location.reload()"></i>
                </div>
                <div class="text-end mt-2">
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#depositModal">
                        + Add Balance
                    </button>
                </div>
            </div>

            <!-- Notice Board -->
            <div class="notice-board">
                <i class="fas fa-bell"></i> Assalamu Alaikum, whenever you place the order will take time to be active according to the order. If it is a small order, then the order will be active with in 10-20 minutes. will get!
            </div>

            <!-- Purchase Form -->
            <div class="purchase-card">
                <div class="pending-title"><i class="fas fa-shopping-cart"></i> Purchase Form</div>
                
                <!-- Select Option -->
                <label class="fw-bold small mb-2"><i class="fas fa-sitemap"></i> Select Your Option:</label>
                <select class="form-select mb-3" id="serviceSelect" onchange="handleServiceSelect()">
                    <option value="" selected disabled>Choose option</option>
                    <option disabled>Loading services...</option>
                </select>

                <!-- Dynamic Inputs -->
                <div id="dynamicInputs" style="display:none;">
                    <div class="d-flex justify-content-between mb-2">
                        <small class="fw-bold">Price:</small>
                        <small class="fw-bold text-primary"><span id="priceDisplay">0</span> PKR</small>
                    </div>

                    <!-- CNIC Input -->
                    <div id="grpCNIC" class="mb-3" style="display:none;">
                        <label class="fw-bold small mb-1"><i class="fas fa-id-card"></i> CNIC Number:</label>
                        <input type="text" id="inpCNIC" class="form-control" placeholder="Enter CNIC number">
                    </div>

                    <!-- Phone Input -->
                    <div id="grpPhone" class="mb-3" style="display:none;">
                        <label class="fw-bold small mb-1"><i class="fas fa-phone-alt"></i> Phone Number:</label>
                        <input type="text" id="inpPhone" class="form-control" placeholder="Enter phone number">
                    </div>
                </div>

                <!-- Purchase Button -->
                <button id="btnPurchase" class="btn-purchase" onclick="confirmOrder()" disabled>
                    <i class="fas fa-shopping-cart"></i> Purchase Now
                </button>
            </div>

            <!-- Pending Requests -->
            <div class="info-card mt-3">
                <div class="pending-title"><i class="fas fa-clock"></i> Pending Requests</div>
                <div id="ordersList" class="bg-light border rounded p-2" style="max-height: 250px; overflow-y: auto;">
                    <small class="text-muted text-center d-block">No pending requests.</small>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-4 mb-5 text-muted small">
                Developer | Â© 2024 Cyber Port | All Rights Reserved
            </div>

        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deposit Funds</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Easypaisa:</strong> <span id="epNum">Loading...</span><br>
                        Min Deposit: 400 PKR
                    </div>
                    <form id="depForm">
                        <input type="number" id="depAmt" class="form-control mb-2" placeholder="Amount Sent" required>
                        <input type="text" id="depTrx" class="form-control" placeholder="Trx ID" required>
                        <button class="btn btn-primary w-100 mt-3">Submit Request</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- TIDIO LIVE CHAT -->
    <script src="//code.tidio.co/uenifm98qobxmzc77sv3lpqkmty985vm.js" async></script>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, onSnapshot, query, where, orderBy, increment, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyADJISrQY1JAtouawLdcWGJrqbFJKyusbQ",
            authDomain: "cyberport-f320e.firebaseapp.com",
            databaseURL: "https://cyberport-f320e-default-rtdb.firebaseio.com",
            projectId: "cyberport-f320e",
            storageBucket: "cyberport-f320e.firebasestorage.app",
            messagingSenderId: "549894694554",
            appId: "1:549894694554:web:d64cc77c8c2696f0aae123"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let curUser = null;
        let curBal = 0;
        let servicesData = [];

        window.toggleReg = () => { const l=document.getElementById('loginForm'),r=document.getElementById('regForm'); if(l.style.display=='none'){l.style.display='block';r.style.display='none'}else{l.style.display='none';r.style.display='block'} };

        document.getElementById('loginForm').addEventListener('submit', (e)=>{ e.preventDefault(); signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value).catch(e=>alert(e.message)); });

        document.getElementById('regForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            try {
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPass').value);
                await setDoc(doc(db,"users",cred.user.uid), { email: cred.user.email, balance: 0 });
                alert("Account Created!");
            } catch(e){ alert(e.message); }
        });

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async(u)=>{
            if(u){
                curUser = u;
                document.getElementById('authSection').style.display='none';
                document.getElementById('appSection').style.display='block';
                document.getElementById('displayEmail').innerText = u.email;
                
                const ur = doc(db,"users",u.uid);
                const s = await getDoc(ur);
                if(!s.exists()) await setDoc(ur, { email: u.email, balance: 0 });
                startApp();
            } else {
                document.getElementById('authSection').style.display='flex';
                document.getElementById('appSection').style.display='none';
            }
        });

        function startApp(){
            // 1. Balance
            onSnapshot(doc(db,"users",curUser.uid), (s)=>{ if(s.exists()) { curBal = s.data().balance || 0; document.getElementById('userBal').innerText = curBal; }});

            // 2. Services List
            onSnapshot(collection(db,"services"), (s)=>{
                const select = document.getElementById('serviceSelect');
                select.innerHTML = '<option value="" selected disabled>Choose option</option>';
                servicesData = [];
                s.forEach(d=>{
                    const v = d.data();
                    servicesData.push({ id: d.id, ...v });
                    select.innerHTML += `<option value="${d.id}">${v.name}</option>`;
                });
            });

            // 3. Orders List
            const q = query(collection(db,"orders"), where("userId","==",curUser.uid));
            onSnapshot(q, (s)=>{
                const l = document.getElementById('ordersList');
                l.innerHTML='';
                if(s.empty) { l.innerHTML='<small class="text-muted d-block text-center">No pending requests.</small>'; return; }
                
                s.forEach(d=>{
                    const o = d.data();
                    let badgeColor = o.status === 'pending' ? 'bg-warning text-dark' : 'bg-success';
                    let btn = '';
                    if(o.status === 'completed' && o.imageUrl) {
                        btn = `<br><a href="${o.imageUrl}" target="_blank" class="btn btn-xs btn-success mt-1 py-0" style="font-size:10px;">View Result</a>`;
                    }

                    l.innerHTML += `
                    <div class="request-item">
                        <div class="d-flex justify-content-between">
                            <strong>${o.serviceName}</strong>
                            <span class="badge ${badgeColor}">${o.status}</span>
                        </div>
                        <div class="small text-muted mt-1">
                            ${o.cnic ? 'CNIC: '+o.cnic : ''} ${o.phone ? '| Ph: '+o.phone : ''}
                        </div>
                        ${btn}
                    </div>`;
                });
            });

            // 4. Settings
            getDocs(collection(db,"settings")).then(s=>{ if(!s.empty) document.getElementById('epNum').innerText = s.docs[0].data().easypaisaNumber || "N/A"; });
        }

        window.handleServiceSelect = () => {
            const select = document.getElementById('serviceSelect');
            const selectedId = select.value;
            const service = servicesData.find(s => s.id === selectedId);

            if(service) {
                document.getElementById('dynamicInputs').style.display = 'block';
                document.getElementById('priceDisplay').innerText = service.price;
                
                const showCnic = service.reqCnic !== false; 
                const showPhone = service.reqPhone !== false;

                document.getElementById('grpCNIC').style.display = showCnic ? 'block' : 'none';
                document.getElementById('grpPhone').style.display = showPhone ? 'block' : 'none';

                const btn = document.getElementById('btnPurchase');
                btn.classList.add('active');
                btn.disabled = false;
                btn.style.backgroundColor = "#6c757d";
            }
        };

        window.confirmOrder = async() => {
            const select = document.getElementById('serviceSelect');
            const selectedId = select.value;
            const service = servicesData.find(s => s.id === selectedId);
            if(!service) return;

            const cVal = document.getElementById('inpCNIC').value;
            const pVal = document.getElementById('inpPhone').value;

            if(document.getElementById('grpCNIC').style.display !== 'none' && !cVal) return alert("Please enter CNIC");
            if(document.getElementById('grpPhone').style.display !== 'none' && !pVal) return alert("Please enter Phone Number");

            if(curBal < service.price) return alert("Insufficient Balance!");

            const btn = document.getElementById('btnPurchase');
            btn.innerHTML = "Processing..."; btn.disabled = true;

            try {
                await updateDoc(doc(db,"users",curUser.uid), { balance: increment(-service.price) });
                await addDoc(collection(db,"orders"), {
                    userId: curUser.uid, serviceName: service.name, price: service.price, cnic: cVal, phone: pVal, status: 'pending', timestamp: new Date()
                });
                alert("Order Placed Successfully!");
                select.value = "";
                document.getElementById('dynamicInputs').style.display = 'none';
                document.getElementById('inpCNIC').value = ""; document.getElementById('inpPhone').value = "";
                btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Purchase Now'; btn.classList.remove('active'); btn.style.backgroundColor = "#ccc";

            } catch(e){ alert(e.message); btn.disabled = false; btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Purchase Now'; }
        };

        window.copyEmail = () => {
            const text = document.getElementById('displayEmail').innerText;
            navigator.clipboard.writeText(text);
            alert("Email copied!");
        };

        document.getElementById('depForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            try {
                await addDoc(collection(db,"deposits"), {
                    userId: curUser.uid, userEmail: curUser.email, amount: Number(document.getElementById('depAmt').value), trxId: document.getElementById('depTrx').value, status: 'pending', timestamp: new Date()
                });
                alert("Deposit Request Sent!"); document.getElementById('depForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('depositModal')).hide();
            } catch(e){ alert(e.message); }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
